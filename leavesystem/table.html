<table class="table table-striped table-bordered table-hover">
  <thead class="table-secondary text-dark">
    <tr>
      <th style="border: 1px solid #ddd; padding: 8px;">เวลาที่บันทึก</th>
      <th style="border: 1px solid #ddd; padding: 8px;">ชื่อ</th>
      <th style="border: 1px solid #ddd; padding: 8px;">ประเภท</th>
      <th style="border: 1px solid #ddd; padding: 8px;">เริ่ม</th>
      <th style="border: 1px solid #ddd; padding: 8px;">ถึง</th>
      <th style="border: 1px solid #ddd; padding: 8px;">ลบ</th>
    </tr>
  </thead>
  <tbody id="leaveTableBody">
    <tr>
      <td colspan="6" style="text-align: center;">กำลังโหลดข้อมูล...</td>
    </tr>
  </tbody>
</table>

<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmationModalLabel">ยืนยันการลบ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ลบ</button>
      </div>
    </div>
  </div>
</div>

<script>
  let timestampToDelete; // ตัวแปรเก็บ timestamp ที่ต้องการลบ

  // ฟังก์ชันสำหรับแสดง Modal ยืนยันการลบ
  function showDeleteConfirmation(timestamp) {
    timestampToDelete = timestamp;
    const deleteConfirmationModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
    deleteConfirmationModal.show();
  }

  // เมื่อคลิกปุ่ม "ยืนยันการลบ" ใน Modal
  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    console.log("กำลังลบรายการที่มี Timestamp:", timestampToDelete);
    google.script.run
      .withSuccessHandler(fetchLeaveData)
      .withFailureHandler(function(error) {
        alert("เกิดข้อผิดพลาด: " + error.message);
      })
      .deleteLeaveData(timestampToDelete);

    // ปิด Modal หลังจากลบ (หรือเกิดข้อผิดพลาด)
    const deleteConfirmationModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal'));
    deleteConfirmationModal.hide();
  });

  // ฟังก์ชันสำหรับลบรายการลา (เรียก showDeleteConfirmation แทน confirm)
  function deleteLeaveEntry(timestamp) {
    showDeleteConfirmation(timestamp);
  }

  // ฟังก์ชันสำหรับรายการวันลา
  function fetchLeaveData() {
    console.log("เริ่มดึงข้อมูลวันลา...");
    const tbody = document.getElementById("leaveTableBody");

    // แสดงข้อความ "กำลังโหลดข้อมูล..."
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">กำลังโหลดข้อมูล...</td></tr>';

    // เรียกใช้ฟังก์ชัน getLeaveDataForClient ที่เซิร์ฟเวอร์
    google.script.run
      .withSuccessHandler(function(data) {
        // เคลียร์ข้อความ "กำลังโหลดข้อมูล..."
        tbody.innerHTML = "";

        console.log("ได้รับข้อมูล:", data);

        // ตรวจสอบว่าได้รับข้อมูลที่ถูกต้อง
        if (data && Array.isArray(data)) {
          console.log("จำนวนแถวข้อมูล:", data.length);

          // ถ้ามีข้อมูลมากกว่า 1 แถว (รวมหัวตาราง)
          if (data.length > 1) {
            console.log("พบข้อมูล, กำลังแสดงผล...");

            // เริ่มจากแถวที่ 1 (ข้ามหัวตาราง)
            for (let i = 1; i < data.length; i++) {
              const row = data[i];
              console.log("แถวที่", i, ":", row);

              if (row && row.length >= 5) {
                // สร้างแถวใหม่
                const tr = document.createElement("tr");
                tr.dataset.rawTimestamp = row[0];

                // วนลูปสร้าง cell แต่ละคอลัมน์
                for (let j = 0; j < 5; j++) {
                  const td = document.createElement("td");
                  td.style.border = "1px solid #ddd";
                  td.style.padding = "8px";

                  let cellValue = row[j] || "";

                  // จัดการกับวันที่และเวลาสำหรับการแสดงผล
                  if (j === 0 || j === 3 || j === 4) {
                    try {
                      const date = new Date(cellValue);
                      if (!isNaN(date.getTime())) {
                        cellValue = date.toLocaleString('th-TH');
                      }
                    } catch (e) {
                      /* ใช้ค่าเดิมถ้าแปลงไม่ได้ */
                    }
                  }

                  td.textContent = cellValue;
                  tr.appendChild(td);
                }

                // เพิ่มปุ่ม "ลบ" ในคอลัมน์สุดท้าย
                const deleteTd = document.createElement("td");
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "ลบ";
                deleteButton.classList.add("btn", "btn-danger", "btn-sm");
                deleteButton.onclick = function() {
                  const rawTimestamp = this.parentNode.parentNode.dataset.rawTimestamp;
                  showDeleteConfirmation(rawTimestamp); // เรียก showDeleteConfirmation แทน confirm
                };
                deleteTd.appendChild(deleteButton);
                tr.appendChild(deleteTd);

                tbody.appendChild(tr);
              } else {
                console.warn("พบแถวข้อมูลที่ไม่สมบูรณ์:", row);
              }
            }
          } else {
            console.log("ไม่พบข้อมูลวันลา (มีเพียงแถวหัวตาราง)");
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ไม่มีข้อมูลวันลา</td></tr>';
          }
        } else {
          console.error("รูปแบบข้อมูลไม่ถูกต้อง:", data);
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ไม่สามารถแสดงข้อมูลได้</td></tr>';
        }
      })
      .withFailureHandler(function(error) {
        console.error("เกิดข้อผิดพลาด:", error);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
      })
      .getLeaveDataForClient();
  }

  // เรียกใช้ฟังก์ชันเมื่อหน้าเว็บโหลดเสร็จ
  document.addEventListener('DOMContentLoaded', fetchLeaveData);
</script>
